<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MC Use – Test (with Crop)</title>

  <!-- Basic styles -->
  <style>
    body { font-family: system-ui, Arial; max-width: 820px; margin: 2rem auto; padding: 0 1rem; }
    h2 { margin-bottom: .75rem; }
    fieldset { border: 1px solid #ddd; padding: 1rem; border-radius: .5rem; }
    label { display: block; margin: .6rem 0 .3rem; }
    select, input[type=file], input[type=text], button { padding: .5rem; font-size: 1rem; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .muted { color: #666; font-size: .9rem; }
    .preview { margin-top: .5rem; max-width: 100%; max-height: 220px; border: 1px dashed #bbb; border-radius: .4rem; object-fit: contain; }
    .log { background:#f7f7f7; border:1px solid #eee; padding:.5rem .75rem; border-radius:.4rem; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color: #0a7a2f; }
    .err { color: #b00020; }
    .btn-row { display:flex; gap:.5rem; flex-wrap: wrap; margin-top:.4rem; }
    .small { font-size:.9rem; padding:.35rem .6rem; }
    .hint { font-size:.85rem; color:#555; }

    /* Crop modal */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.open { display: flex; }
    .modal-card {
      background: #fff; padding: 1rem; border-radius: .6rem; max-width: 95vw; max-height: 90vh; width: 880px;
      display:flex; flex-direction: column; gap:.6rem;
    }
    .crop-wrap { flex:1; min-height: 360px; border:1px solid #ddd; position:relative; overflow:hidden; }
    .crop-wrap img { max-width: 100%; display:block; }
    .modal-actions { display:flex; flex-wrap: wrap; gap:.5rem; justify-content: space-between; align-items:center; }
    .left-actions, .right-actions { display:flex; gap:.5rem; align-items:center; }
  </style>

  <!-- Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- Cropper.js -->
  <link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
</head>
<body>
  <h2>Medical Certificate (MC) Use – Test (with Crop)</h2>
  <p class="muted">Sandbox to verify OCR + Drive + Sheets. You can crop images before OCR/upload.</p>

  <form id="mcForm">
    <fieldset>
      <label for="zone">Zone</label>
      <select id="zone" required>
        <option value="">— Select —</option>
        <option>Green</option>
        <option>Yellow</option>
        <option>Red</option>
      </select>

      <div class="row-2">
        <div>
          <label for="sticker">Patient sticker photo</label>
          <input type="file" id="sticker" accept="image/*" capture="environment" required />
          <div class="btn-row">
            <button type="button" id="cropStickerBtn" class="small">Crop sticker</button>
          </div>
          <img id="stickerPreview" class="preview" alt="">
          <div class="hint">Tip: crop to include only the patient name (top line) and the UPM MRN line.</div>
        </div>

        <div>
          <label for="mcfile">Medical Certificate photo</label>
          <input type="file" id="mcfile" accept="image/*" capture="environment" required />
          <div class="btn-row">
            <button type="button" id="cropMcBtn" class="small">Crop MC</button>
          </div>
          <img id="mcPreview" class="preview" alt="">
          <div class="hint">Optional: crop to exclude background/PII you don’t need.</div>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label>OCR result (server-parsed)</label>
          <div id="ocrResult" class="log muted">— waiting —</div>
        </div>
        <div>
          <label>Manual override (optional)</label>
          <input type="text" id="nameManual" placeholder="Name (override)">
          <input type="text" id="mrnManual" placeholder="MRN (UPMxxxxxxxxx)">
          <div class="hint">If filled, these will override OCR outputs.</div>
        </div>
      </div>

      <div style="margin-top:1rem" class="btn-row">
        <button id="submitBtn" type="submit">Submit test</button>
      </div>
    </fieldset>
  </form>

  <div style="margin-top:1rem">
    <div id="status" class="log">Status: idle</div>
  </div>

  <!-- Crop Modal -->
  <div id="cropModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <strong id="cropTitle">Crop Image</strong>
      <div class="crop-wrap">
        <img id="cropImage" alt="">
      </div>
      <div class="modal-actions">
        <div class="left-actions">
          <button type="button" id="rotateLeft" class="small">⟲ Rotate -90°</button>
          <button type="button" id="rotateRight" class="small">⟳ Rotate +90°</button>
          <button type="button" id="resetCrop" class="small">Reset</button>
          <span class="hint">Zoom with mouse wheel / pinch</span>
        </div>
        <div class="right-actions">
          <button type="button" id="cancelCrop" class="small">Cancel</button>
          <button type="button" id="confirmCrop" class="small">Crop & Use</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1) Paste your deployed Google Apps Script Web App URL here:
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwoijzTp_nlEfdXawiLNxPXu0e5sH9qM5FOSJFkzJVoUA0kGZjRAbZAcM1wUJmRwMuC/exec";

    // --- DOM refs ---
    const $ = (id) => document.getElementById(id);
    const stickerInput = $("sticker");
    const mcInput = $("mcfile");
    const stickerPreview = $("stickerPreview");
    const mcPreview = $("mcPreview");
    const ocrBox = $("ocrResult");
    const statusBox = $("status");
    const submitBtn = $("submitBtn");
    const cropModal = $("cropModal");
    const cropImage = $("cropImage");
    const cropTitle = $("cropTitle");

    const cropStickerBtn = $("cropStickerBtn");
    const cropMcBtn = $("cropMcBtn");
    const rotateLeftBtn = $("rotateLeft");
    const rotateRightBtn = $("rotateRight");
    const resetCropBtn = $("resetCrop");
    const cancelCropBtn = $("cancelCrop");
    const confirmCropBtn = $("confirmCrop");

    const nameManual = $("nameManual");
    const mrnManual = $("mrnManual");

    let cropper = null;
    let cropTarget = null; // "sticker" | "mc"
    let stickerCroppedBlob = null;
    let mcCroppedBlob = null;

    function setStatus(msg, ok=false, err=false){
      statusBox.textContent = msg;
      statusBox.className = "log" + (ok ? " ok" : "") + (err ? " err" : "");
    }

    function showPreviewFromFile(input, imgEl){
      const f = input.files?.[0];
      if (!f) { imgEl.src = ""; imgEl.alt = ""; return; }

      // HEIC cannot render in <img> in most browsers
      if (/image\/hei(c|f)/i.test(f.type) || /\.hei(c|f)$/i.test(f.name)) {
        imgEl.src = "";
        imgEl.alt = `(Preview not supported for ${f.type || f.name})`;
        return;
      }

      const url = URL.createObjectURL(f);
      imgEl.src = url;
      imgEl.onload = () => URL.revokeObjectURL(url);
    }

    stickerInput.addEventListener("change", () => {
      showPreviewFromFile(stickerInput, stickerPreview);
      stickerCroppedBlob = null; // reset crop if file changed
    });
    mcInput.addEventListener("change", () => {
      showPreviewFromFile(mcInput, mcPreview);
      mcCroppedBlob = null;
    });

    // --- Cropper helpers ---
    function openCropperFor(input, title){
      const file = input.files?.[0];
      if (!file) { alert("Please choose a file first."); return; }

      if (/image\/hei(c|f)/i.test(file.type)) {
        alert("HEIC/HEIF preview/cropping is not supported by the browser. Change iPhone Camera Format to 'Most Compatible' (JPEG) in Settings, or upload a JPEG/PNG.");
        return;
      }

      cropTitle.textContent = title;
      const url = URL.createObjectURL(file);
      cropImage.src = url;

      cropImage.onload = () => {
        if (cropper) { cropper.destroy(); cropper = null; }
        cropper = new Cropper(cropImage, {
          viewMode: 1,           // restrict the crop box to not exceed the size of the canvas
          autoCropArea: 0.9,
          responsive: true,
          movable: true,
          zoomable: true,
          rotatable: true,
          scalable: false,
          background: false
        });
      };

      cropTarget = (input === stickerInput) ? "sticker" : "mc";
      cropModal.classList.add("open");
    }

    cropStickerBtn.addEventListener("click", () => openCropperFor(stickerInput, "Crop Sticker (focus on Name line & UPM MRN)"));
    cropMcBtn.addEventListener("click", () => openCropperFor(mcInput, "Crop Medical Certificate"));

    rotateLeftBtn.addEventListener("click", () => cropper?.rotate(-90));
    rotateRightBtn.addEventListener("click", () => cropper?.rotate(90));
    resetCropBtn.addEventListener("click", () => cropper?.reset());
    cancelCropBtn.addEventListener("click", () => {
      cropModal.classList.remove("open");
      if (cropper) { cropper.destroy(); cropper = null; }
    });

    confirmCropBtn.addEventListener("click", () => {
      if (!cropper) return;
      // Export cropped area to JPEG blob
      const canvas = cropper.getCroppedCanvas({ maxWidth: 4096, maxHeight: 4096 });
      canvas.toBlob((blob) => {
        if (!blob) { alert("Failed to crop image."); return; }
        if (cropTarget === "sticker") {
          stickerCroppedBlob = blob;
          // Update preview to cropped
          const url = URL.createObjectURL(blob);
          stickerPreview.src = url;
          stickerPreview.onload = () => URL.revokeObjectURL(url);
        } else {
          mcCroppedBlob = blob;
          const url = URL.createObjectURL(blob);
          mcPreview.src = url;
          mcPreview.onload = () => URL.revokeObjectURL(url);
        }
        cropModal.classList.remove("open");
        cropper.destroy(); cropper = null;
      }, "image/jpeg", 0.92);
    });

    // --- OCR & Submit ---
    function fileOrBlobToBase64(obj) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result).split(",")[1] || "");
        fr.onerror = reject;
        fr.readAsDataURL(obj);
      });
    }

    async function runStickerOCR(blobOrFile){
      // Try OCR on cropped (or original if not cropped)
      try {
        const { createWorker } = Tesseract;
        const worker = await createWorker({ logger: () => {} });
        await worker.loadLanguage("eng");
        await worker.initialize("eng");
        const res = await worker.recognize(blobOrFile);
        await worker.terminate();
        return (res?.data?.text) || "";
      } catch (e) {
        console.error("OCR failed:", e);
        return "";
      }
    }

    function cleanAndExtractNameMrn(text) {
      if (!text) return { name:null, mrn:null };
      const cleaned = text
        .replace(/[^\x09\x0A\x0D\x20-\x7E]/g,' ')
        .replace(/\u200B/g,'')
        .replace(/\s{2,}/g,' ')
        .trim();

      const lines = cleaned.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const name = (lines[0] || '') || null; // take first line as Name

      const mrnMatch = cleaned.match(/\b(UPM\d{6,12})\b/i);
      const mrn = mrnMatch ? mrnMatch[1].toUpperCase() : null;

      return { name, mrn };
    }

    document.getElementById("mcForm").addEventListener("submit", onSubmit);

    async function onSubmit(e){
      e.preventDefault();
      const zone = document.getElementById("zone").value;
      const stickerFile = stickerInput.files[0];
      const mcFile = mcInput.files[0];

      if (!zone || !stickerFile || !mcFile) {
        alert("Please complete all fields.");
        return;
      }

      // Decide what to feed to OCR & upload
      const stickerForOcr = stickerCroppedBlob || stickerFile;
      const mcForUpload = mcCroppedBlob || mcFile;

      setStatus("Running OCR on (cropped) sticker…");
      let ocrText = await runStickerOCR(stickerForOcr);

      // Extract fields, then apply manual overrides if provided
      let { name, mrn } = cleanAndExtractNameMrn(ocrText);
      if (nameManual.value.trim()) name = nameManual.value.trim();
      if (mrnManual.value.trim())  mrn  = mrnManual.value.trim().toUpperCase();

      // Prepare payload: use cropped blobs if present
      setStatus("Uploading to Drive & writing to Sheet…");
      submitBtn.disabled = true;

      try {
        const [stickerB64, mcB64] = await Promise.all([
          fileOrBlobToBase64(stickerForOcr),
          fileOrBlobToBase64(mcForUpload)
        ]);

        const payload = {
          zone,
          ocrText, // still send raw (cropped) OCR text for server logging/parsing
          nameOverride: name || null,
          mrnOverride: mrn || null,
          sticker: { name: stickerFile.name, mime: "image/jpeg", b64: stickerB64 },
          mcfile:  { name: mcFile.name,     mime: "image/jpeg", b64: mcB64 }
        };

        const resp = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error(`HTTP ${resp.status} – ${txt.slice(0,200)}`);
        }
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "Unknown server error");

        setStatus("Success ✔ Files uploaded & row added.", true);
        ocrBox.textContent = `Name=${name || data.name || "—"} | MRN=${mrn || data.mrn || "—"}\nSticker: ${data?.sticker?.url || "—"}\nMC: ${data?.mc?.url || "—"}`;
        alert("OK:\n" + JSON.stringify(data, null, 2));
      } catch (err) {
        console.error(err);
        setStatus("Failed: " + err.message, false, true);
        alert("Error:\n" + err.message);
      } finally {
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
